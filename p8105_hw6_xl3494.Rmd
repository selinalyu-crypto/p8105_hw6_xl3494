---
title: "p8105_hw6_xl3494"
author: Selina Lyu
output: github_document
---
```{r, include = FALSE}
library(tidyverse)
library(broom)

set.seed(1)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = 0.6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

Import the raw data
```{r}
hom_raw = readr::read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")
```

Clean the dataset

```{r}
hom = 
  hom_raw |>
  mutate(city_state = str_c(city,", ", state),
         solved = disposition == "Closed by arrest",
         victim_age = as.numeric(victim_age)) |>
  mutate(solved = as.integer(solved)) |>
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ",
                       "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black"),
    !is.na(victim_age)
  )
```

For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors.

```{r}
fit_balt =
  hom |>
  filter(city_state == "Baltimore, MD") |>
  mutate(
    victim_sex  = fct_relevel(victim_sex, "Female"),
    victim_race = fct_relevel(victim_race, "White")) |>
  glm(
  solved ~ victim_age + victim_sex + victim_race,
  data = _, family = binomial)


fit_balt_tidy =
  fit_balt |>
  broom::tidy(conf.int = TRUE) |>
  mutate(OR = exp(estimate), 
         lower_ci = exp(conf.low),
         upper_ci = exp(conf.high)) |>
  select(term, log_OR = estimate, OR, lower_ci, upper_ci, p.value) |> 
  knitr::kable(digits = 3)

fit_balt_tidy
```

Male victimsâ€™ homicide cases are about 57% less likely to be solved than female victims (OR = 0.426), holding age and race constant. We are 95% confident that the true odds ratio lies between 0.324 and 0.558.

Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims. 

```{r, warning=FALSE}
city_or =
  hom |>
  mutate(
    victim_sex  = fct_relevel(victim_sex,  "Female"),
    victim_race = fct_relevel(victim_race, "White")
  ) |>
  group_by(city_state) |>
  nest() |>
  mutate(
    models  = map(data, \(df) glm(
      solved ~ victim_age + victim_sex + victim_race,
      data = df, family = binomial)),
    results = map(models, \(m) tidy(m, conf.int = TRUE))
  ) |>
  unnest(results) |>
  filter(term == "victim_sexMale") |>
  mutate(
    OR    = exp(estimate),
    lower = exp(conf.low),
    upper = exp(conf.high)
  ) |>
  select (city_state, term, OR, lower, upper, p.value)

city_or
```

Create a plot that shows the estimated ORs and CIs for each city.

```{r, fig.height=7, fig.width=7, fig.asp=NA, out.width="80%"}
city_or |>
  ungroup() |>
  arrange(OR) |> 
  mutate(city_state = fct_reorder(city_state, OR)) |>
  ggplot(aes(x = city_state, y = OR, ymin = lower, ymax = upper)) +
  geom_pointrange() +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  labs(
    x = "City",
    y = "Adjusted OR (Male vs Female)",
    title = "Adjusted odds of homicide being solved for male vs female victims"
  )
```








