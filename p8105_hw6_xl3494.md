p8105_hw6_xl3494
================
Selina Lyu

## Problem 1

Import the raw data

``` r
hom_raw = readr::read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

Clean the dataset

``` r
hom = 
  hom_raw |>
  mutate(city_state = str_c(city,", ", state),
         solved = disposition == "Closed by arrest",
         victim_age = as.numeric(victim_age)) |>
  mutate(solved = as.integer(solved)) |>
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ",
                       "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black"),
    !is.na(victim_age)
  )
```

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `victim_age = as.numeric(victim_age)`.
    ## Caused by warning:
    ## ! NAs introduced by coercion

For the city of Baltimore, MD, use the glm function to fit a logistic
regression with resolved vs unresolved as the outcome and victim age,
sex and race as predictors.

``` r
fit_balt =
  hom |>
  filter(city_state == "Baltimore, MD") |>
  mutate(
    victim_sex  = fct_relevel(victim_sex, "Female"),
    victim_race = fct_relevel(victim_race, "White")) |>
  glm(
  solved ~ victim_age + victim_sex + victim_race,
  data = _, family = binomial)


fit_balt_tidy =
  fit_balt |>
  broom::tidy(conf.int = TRUE) |>
  mutate(OR = exp(estimate), 
         lower_ci = exp(conf.low),
         upper_ci = exp(conf.high)) |>
  select(term, log_OR = estimate, OR, lower_ci, upper_ci, p.value) |> 
  knitr::kable(digits = 3)

fit_balt_tidy
```

| term             | log_OR |    OR | lower_ci | upper_ci | p.value |
|:-----------------|-------:|------:|---------:|---------:|--------:|
| (Intercept)      |  1.152 | 3.164 |    1.998 |    5.057 |   0.000 |
| victim_age       | -0.007 | 0.993 |    0.987 |    1.000 |   0.043 |
| victim_sexMale   | -0.854 | 0.426 |    0.324 |    0.558 |   0.000 |
| victim_raceBlack | -0.842 | 0.431 |    0.305 |    0.606 |   0.000 |

Male victims’ homicide cases are about 57% less likely to be solved than
female victims (OR = 0.426), holding age and race constant. We are 95%
confident that the true odds ratio lies between 0.324 and 0.558.

Now run glm for each of the cities in your dataset, and extract the
adjusted odds ratio (and CI) for solving homicides comparing male
victims to female victims.

``` r
city_or =
  hom |>
  mutate(
    victim_sex  = fct_relevel(victim_sex,  "Female"),
    victim_race = fct_relevel(victim_race, "White")
  ) |>
  group_by(city_state) |>
  nest() |>
  mutate(
    models  = map(data, \(df) glm(
      solved ~ victim_age + victim_sex + victim_race,
      data = df, family = binomial)),
    results = map(models, \(m) tidy(m, conf.int = TRUE))
  ) |>
  unnest(results) |>
  filter(term == "victim_sexMale") |>
  mutate(
    OR    = exp(estimate),
    lower = exp(conf.low),
    upper = exp(conf.high)
  ) |>
  select (city_state, term, OR, lower, upper, p.value)

city_or
```

    ## # A tibble: 47 × 6
    ## # Groups:   city_state [47]
    ##    city_state      term              OR lower upper   p.value
    ##    <chr>           <chr>          <dbl> <dbl> <dbl>     <dbl>
    ##  1 Albuquerque, NM victim_sexMale 1.77  0.825 3.76  1.39 e- 1
    ##  2 Atlanta, GA     victim_sexMale 1.00  0.680 1.46  1.000e+ 0
    ##  3 Baltimore, MD   victim_sexMale 0.426 0.324 0.558 6.26 e-10
    ##  4 Baton Rouge, LA victim_sexMale 0.381 0.204 0.684 1.65 e- 3
    ##  5 Birmingham, AL  victim_sexMale 0.870 0.571 1.31  5.11 e- 1
    ##  6 Boston, MA      victim_sexMale 0.674 0.353 1.28  2.26 e- 1
    ##  7 Buffalo, NY     victim_sexMale 0.521 0.288 0.936 2.90 e- 2
    ##  8 Charlotte, NC   victim_sexMale 0.884 0.551 1.39  6.00 e- 1
    ##  9 Chicago, IL     victim_sexMale 0.410 0.336 0.501 1.86 e-18
    ## 10 Cincinnati, OH  victim_sexMale 0.400 0.231 0.667 6.49 e- 4
    ## # ℹ 37 more rows

Create a plot that shows the estimated ORs and CIs for each city.

``` r
city_or |>
  ungroup() |>
  arrange(OR) |> 
  mutate(city_state = fct_reorder(city_state, OR)) |>
  ggplot(aes(x = city_state, y = OR, ymin = lower, ymax = upper)) +
  geom_pointrange() +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  labs(
    x = "City",
    y = "Adjusted OR (Male vs Female)",
    title = "Adjusted odds of homicide being solved for male vs female victims"
  )
```

<img src="p8105_hw6_xl3494_files/figure-gfm/unnamed-chunk-6-1.png" width="80%" />
